<!DOCTYPE html>
<html>
	<head>
		
<title>tampermonkey油猴-newbie</title>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<meta name="referrer" content="no-referrer" />

<link rel="shortcut icon" type="image/x-icon" href="/image/favicon.ico">

<link rel="stylesheet" href="/css/index.css">



<meta name="keywords" content="JavaScript,tampermonkey,">
<meta name="description" content="tampermonkey油猴的脚本用来获取页面数">


<script src="/js/jquery.min.js"></script>


<script src="/js/index.js"></script>


<script src="/js/fancybox.umd.js"></script>


<script src="/js/fancybox-images.js"></script>


<script src="/js/gitalk.min.js"></script>


<script src="/js/hljs.min.js"></script>
 
<script>hljs.highlightAll();</script>

	<meta name="generator" content="Hexo 7.3.0"></head>

	<body>
		
	<div class="header">
		<div class="header-top" id="header-top">
			<div class="h-left">
				<a href="/">
					<img src="/image/logo.png" alt="FPF">
				</a>
				
				<span style="color: #c9d1d9;font-weight: bolder; ">&nbsp;&nbsp;付鹏篚的笔记 </span>
			</div>
			<div class="h-right">
				<ul>
					
						
								<li>
									<a href="/">
										主页
									</a>
									<span class="dot"></span>
								</li>
								
									
						
								<li>
									<a href="/archives">
										归档
									</a>
									<span class="dot"></span>
								</li>
								
									
						
								<li>
									<a href="/categories">
										分类
									</a>
									<span class="dot"></span>
								</li>
								
									
						
								<li>
									<a href="/tags">
										标签
									</a>
									<span class="dot"></span>
								</li>
								
									
						
								<li>
									<a href="/about">
										关于
									</a>
									<span class="dot"></span>
								</li>
								
									
				</ul>
			</div>
			<div class="h-right-close">
				<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="24" height="24">
					<path fill="none" d="M0 0h24v24H0z" />
					<path d="M3 4h18v2H3V4zm0 7h18v2H3v-2zm0 7h18v2H3v-2z" fill="rgba(68,68,68,1)" />
				</svg>
			</div>
		</div>
	</div>
	<div class="sidebar">
    <div class="topo">
        <h2>付鹏篚</h2>
    </div>
    <ul>
        
        <li>
            <a href="/">主页</a>
        </li>
        
        <li>
            <a href="/archives">归档</a>
        </li>
        
        <li>
            <a href="/categories">分类</a>
        </li>
        
        <li>
            <a href="/tags">标签</a>
        </li>
        
        <li>
            <a href="/about">关于</a>
        </li>
        
    </ul>
    <div class="my_foot">
        
        <a target="_blank" rel="noopener" href="https://github.com/newbiefpf">
            <img src="/image/logo.png" alt="Quiet主题">
        </a>
        
    </div>
</div>
<div class='shelter'>
</div>
<style>
    .shelter{
        background-color: #333;
        opacity:0.5;
        cursor: pointer;
        display: none; 
        position: fixed;
        left: 0;
        top: 0; 
        right: 0;
        bottom: 0;
        z-index: 1998;
    }
    .sidebar {
        width: 66%;
        height: 100%;
        position: fixed;
        top: 0;
        right: -100%;
        bottom: 0;
        background: #fff;
        z-index: 1999;
        text-align: center;
        box-shadow: -6px 0 20px rgba(98, 94, 94, .815);
    }

    .topo {
        width: 100%;
        height: 200px;
        background: url(https://api.ixiaowai.cn/gqapi/gqapi.php) no-repeat;
        background-size: 100% 100%;
        position: relative;
        display: flex;
        align-items: flex-end
    }

    .topo h2 {
        color: #fff;
        z-index: 1;
        position: relative;
        margin: 0 0 10px 10px;
        font-size: 1.2em;
        box-sizing: border-box
    }

    .topo:before {
        content: '';
        background-image: url(/image/pattern.png);
        background-repeat: repeat;
        height: 100%;
        left: 0;
        position: absolute;
        top: 0;
        width: 100%;
        z-index: 1
    }

    .sidebar ul {
        width: 100%;
        margin-top: 50px
    }

    .sidebar ul li {
        height: 50px;
        list-style: none;
        font-size: 1.2em;
        text-align: right;
        margin-right: 10px
    }

    .sidebar ul li a {
        display: grid;
        color: #5d606a;
        text-overflow: ellipsis;
        width: 100%;
        text-decoration: none
    }

    .my_foot {
        width: 100%;
        padding: 10px;
        margin-bottom: 10px;
        position: absolute;
        bottom: 0
    }

    .my_foot a {
        text-decoration: none;
        margin-right: 10px;
        display: inline-block
    }

    .my_foot a img {
        width: 30px;
        height: 30px
    }
</style>

<script>
    $( function () {
	$( '.h-right-close>svg' )
		.click( function () {
			$( '.sidebar' )
				.animate( {
					right: "0"
				}, 500 );
			$( '.shelter' )
				.fadeIn( "slow" )
		} );
	$( '.shelter' )
		.click( function ( e ) {
			$( '.sidebar' )
				.animate( {
					right: "-100%"
				}, 500 );
			$( '.shelter' )
				.fadeOut( "slow" )
		} )
} )

</script>

<div class="post">
    <div class="post-header-background post-header-img"
    
>
    <div class="post-header-background-content">
        <ul class="post-header-tag">
            
                
                    <li><a href="/tags/JavaScript">JavaScript</a></li>
                
                    <li><a href="/tags/tampermonkey">tampermonkey</a></li>
                
            
        </ul>
        
        <h1>tampermonkey油猴</h1>

        <div class="post-header-info">
            <div class="post-header-info-author">
                
                    <svg t="1604839279282" class="icon" viewBox="0 0 1024 1024" version="1.1"
                        xmlns="http://www.w3.org/2000/svg" p-id="2901" width="20" height="20">
                        <path
                            d="M513 956.3c-247.7 0-448-200.3-448-448S265.3 66.2 513 66.2s448 200.3 448 448-200.3 442.1-448 442.1z m0-830.9c-212.2 0-388.8 170.7-388.8 388.8C124.2 726.3 294.9 903 513 903c212.2 0 388.8-170.7 388.8-388.8S725.2 125.4 513 125.4z m0 430.2c-94.2 0-170.7-76.5-170.7-170.7S418.8 207.8 513 207.8s170.7 76.5 170.7 170.7S607.2 555.6 513 555.6z m0-289.1c-64.6 0-112 52.8-112 112s47.4 117.9 112 117.9 112-52.8 112-112-47.4-117.9-112-117.9z m0 689.8c-135.7 0-259-58.7-341.9-158.9l-11.8-17.8 11.8-17.8c76.5-117.9 206.2-188.5 347.8-188.5 135.7 0 265 64.6 341.9 182.6l11.8 17.8-11.8 17.8C778 897.1 648.7 956.3 513 956.3zM230.3 773.2C300.9 849.7 406.9 897 513 897c112 0 218.1-47.4 288.6-129.8-70.5-88.2-170.7-135.6-282.7-135.6s-218.1 53.3-288.6 141.6z"
                            p-id="2902" fill="#ffffff"></path>
                    </svg>
                
                <span class="post-header-info-author-text"> 
                    <a target="_blank" rel="noopener" href="https://github.com/newbiefpf">
                        付鹏篚
                    </a>
                </span>
                <div class="post-header-info-author-categories">
                    
                        
                            <a href="../../categories/Tool/" target="_blank">Tool</a>
                        
                    
                </div>
                <p>2023-06-18 20:00:00</p>
            </div>
        </div>
    </div>
</div>

    <div class="post-content" id="content">
  
  <div id="article" class="post-content-info">
    
      <div id="post-toc">
        <span class="post-toc-title">文章目录</span>
        <ol class="toc"><li class="toc-item toc-level-3"><a class="toc-link" href="#1-%E8%84%9A%E6%9C%AC%E5%85%83%E4%BF%A1%E6%81%AF%EF%BC%88Metadata%EF%BC%89"><span class="toc-text">1. 脚本元信息（Metadata）</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-%E5%88%9D%E5%A7%8B%E5%8C%96%E5%8F%98%E9%87%8F"><span class="toc-text">2. 初始化变量</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-startup-%E5%87%BD%E6%95%B0"><span class="toc-text">3. startup 函数</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#3-1-exportFile-%E5%87%BD%E6%95%B0"><span class="toc-text">3.1 exportFile 函数</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#3-2-addButton-%E5%87%BD%E6%95%B0"><span class="toc-text">3.2 addButton 函数</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#3-3-updateDownloaderDiv-%E5%87%BD%E6%95%B0"><span class="toc-text">3.3 updateDownloaderDiv 函数</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#3-4-removeHtmlFromJson-%E5%87%BD%E6%95%B0"><span class="toc-text">3.4 removeHtmlFromJson 函数</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#3-5-%E9%87%8D%E5%86%99-XMLHttpRequest-prototype-open"><span class="toc-text">3.5 重写 XMLHttpRequest.prototype.open</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-%E5%85%B6%E4%BB%96%E5%8A%9F%E8%83%BD"><span class="toc-text">4. 其他功能</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#4-1-checkRequestStatus-%E5%87%BD%E6%95%B0"><span class="toc-text">4.1 checkRequestStatus 函数</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#4-2-sendRequest-%E5%87%BD%E6%95%B0"><span class="toc-text">4.2 sendRequest 函数</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#4-3-%E5%AE%9A%E6%97%B6%E5%99%A8%E5%92%8C%E5%88%9D%E5%A7%8B%E5%8C%96"><span class="toc-text">4.3 定时器和初始化</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%80%BB%E7%BB%93"><span class="toc-text">总结</span></a></li></ol>
      </div>
    

    <h3 id="1-脚本元信息（Metadata）"><a href="#1-脚本元信息（Metadata）" class="headerlink" title="1. 脚本元信息（Metadata）"></a>1. <strong>脚本元信息（Metadata）</strong></h3><pre><code class="hljs javascript"><span class="hljs-comment">// ==UserScript==</span>
<span class="hljs-comment">// @name       租租车</span>
<span class="hljs-comment">// @namespace  tacatman@gmail.com/scripts</span>
<span class="hljs-comment">// @version    1.0</span>
<span class="hljs-comment">// @description 监听所有 Ajax 请求和响应，并在屏幕上渲染一个按钮，允许下载（按请求分组）。以 Mockserver 格式导出。</span>
<span class="hljs-comment">// @author     newbieFPF</span>
<span class="hljs-comment">// @license    GPL</span>
<span class="hljs-comment">// @match      *://w.zuzuche.com/*</span>
<span class="hljs-comment">// @grant      none</span>
<span class="hljs-comment">// @run-at     document-start</span>
<span class="hljs-comment">// @icon       https://global.zuzuche.com/assets/images/common/zzc-logo-0119.png?1677569026</span>
<span class="hljs-comment">// @require    https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/1.3.3/FileSaver.min.js</span>
<span class="hljs-comment">// ==/UserScript==</span></code></pre>
<ul>
<li><strong>@name</strong>: 脚本的名称，这里是“租租车”。</li>
<li><strong>@namespace</strong>: 脚本的命名空间，用于唯一标识脚本。</li>
<li><strong>@version</strong>: 脚本的版本号。</li>
<li><strong>@description</strong>: 脚本的功能描述。该脚本监听所有 Ajax 请求和响应，并在页面上渲染一个按钮，允许用户下载请求数据（按请求分组），并以 Mockserver 格式导出。</li>
<li><strong>@author</strong>: 脚本的作者。</li>
<li><strong>@license</strong>: 脚本的许可证，这里是 GPL。</li>
<li><strong>@match</strong>: 脚本生效的 URL 模式。这里匹配 <code>w.zuzuche.com</code> 域名下的所有页面。</li>
<li><strong>@grant</strong>: 声明脚本需要的特殊权限。这里没有特殊权限需求，因此为 <code>none</code>。</li>
<li><strong>@run-at</strong>: 脚本的运行时机。<code>document-start</code> 表示在文档加载的早期阶段运行。</li>
<li><strong>@icon</strong>: 脚本的图标 URL。</li>
<li><strong>@require</strong>: 脚本依赖的外部库。这里引入了 <code>FileSaver.js</code>，用于实现文件下载功能。</li>
</ul>
<hr>
<h3 id="2-初始化变量"><a href="#2-初始化变量" class="headerlink" title="2. 初始化变量"></a>2. <strong>初始化变量</strong></h3><pre><code class="hljs javascript"><span class="hljs-variable language_">window</span>.<span class="hljs-property">requestSnifferForMock</span> = &#123;&#125;;
<span class="hljs-variable language_">window</span>.<span class="hljs-property">requestSnifferForMockSaveAs</span> = saveAs;
<span class="hljs-keyword">var</span> isRequestInProgress = <span class="hljs-literal">false</span>;
<span class="hljs-keyword">var</span> anotherVariable = [];
<span class="hljs-keyword">var</span> intervalRequest = <span class="hljs-literal">null</span>;</code></pre>
<ul>
<li><strong><code>window.requestSnifferForMock</code></strong>: 用于存储所有捕获的请求和响应数据。</li>
<li><strong><code>window.requestSnifferForMockSaveAs</code></strong>: 将 <code>FileSaver.js</code> 的 <code>saveAs</code> 方法挂载到全局对象，方便后续调用。</li>
<li><strong><code>isRequestInProgress</code></strong>: 标志位，用于判断当前是否有请求正在进行。</li>
<li><strong><code>anotherVariable</code></strong>: 用于存储额外的请求数据。</li>
<li><strong><code>intervalRequest</code></strong>: 用于存储定时器的 ID，方便后续清除。</li>
</ul>
<hr>
<h3 id="3-startup-函数"><a href="#3-startup-函数" class="headerlink" title="3. startup 函数"></a>3. <strong><code>startup</code> 函数</strong></h3><p><code>startup</code> 是脚本的核心逻辑，负责监听 Ajax 请求并处理响应。</p>
<h4 id="3-1-exportFile-函数"><a href="#3-1-exportFile-函数" class="headerlink" title="3.1 exportFile 函数"></a>3.1 <strong><code>exportFile</code> 函数</strong></h4><pre><code class="hljs javascript"><span class="hljs-keyword">var</span> exportFile = <span class="hljs-keyword">function</span> (<span class="hljs-params">key</span>) &#123;
    <span class="hljs-keyword">var</span> blob = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Blob</span>([<span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">stringify</span>(<span class="hljs-variable language_">window</span>.<span class="hljs-property">requestSnifferForMock</span>[key], <span class="hljs-literal">null</span>, <span class="hljs-number">2</span>)], &#123;type : <span class="hljs-string">&#x27;application/json&#x27;</span>&#125;);
    <span class="hljs-title function_">requestSnifferForMockSaveAs</span>(blob, key + <span class="hljs-string">&quot;.json&quot;</span>);
&#125;;</code></pre>
<ul>
<li>功能：将捕获的请求数据导出为 JSON 文件。</li>
<li>参数：<code>key</code> 是请求的路径（如 <code>/list_new_json_5.php</code>）。</li>
<li>实现：<ul>
<li>使用 <code>JSON.stringify</code> 将数据转换为 JSON 字符串。</li>
<li>使用 <code>Blob</code> 创建一个文件对象。</li>
<li>调用 <code>FileSaver.js</code> 的 <code>saveAs</code> 方法将文件保存到本地。</li>
</ul>
</li>
</ul>
<h4 id="3-2-addButton-函数"><a href="#3-2-addButton-函数" class="headerlink" title="3.2 addButton 函数"></a>3.2 <strong><code>addButton</code> 函数</strong></h4><pre><code class="hljs javascript"><span class="hljs-keyword">var</span> addButton = <span class="hljs-keyword">function</span>(<span class="hljs-params">text, func</span>) &#123;
    <span class="hljs-keyword">var</span> div = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">createElement</span>(<span class="hljs-string">&#x27;div&#x27;</span>);
    div.<span class="hljs-title function_">setAttribute</span>(<span class="hljs-string">&#x27;style&#x27;</span>, <span class="hljs-string">&#x27;padding: 10px; display: flex;&#x27;</span>);
    <span class="hljs-keyword">var</span> button = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">createElement</span>(<span class="hljs-string">&#x27;button&#x27;</span>);
    button.<span class="hljs-title function_">setAttribute</span>(<span class="hljs-string">&#x27;style&#x27;</span>, <span class="hljs-string">&#x27;flex: 1 0 auto;width: 90px;height: 30px;line-height: 30px;border: none;color: #fff;background-color: #4e7cdd;border-radius: 3px;text-align: center;cursor: pointer;&#x27;</span> );
    button.<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">&#x27;click&#x27;</span>, func, <span class="hljs-literal">false</span>);
    button.<span class="hljs-property">innerText</span> = text;
    div.<span class="hljs-title function_">appendChild</span>(button);
    <span class="hljs-keyword">return</span> div;
&#125;;</code></pre>
<ul>
<li>功能：创建一个按钮，并绑定点击事件。</li>
<li>参数：<ul>
<li><code>text</code>: 按钮显示的文本。</li>
<li><code>func</code>: 按钮点击时触发的函数。</li>
</ul>
</li>
<li>实现：<ul>
<li>创建一个 <code>div</code> 容器和一个 <code>button</code> 元素。</li>
<li>设置按钮的样式和点击事件。</li>
<li>将按钮添加到 <code>div</code> 中并返回。</li>
</ul>
</li>
</ul>
<h4 id="3-3-updateDownloaderDiv-函数"><a href="#3-3-updateDownloaderDiv-函数" class="headerlink" title="3.3 updateDownloaderDiv 函数"></a>3.3 <strong><code>updateDownloaderDiv</code> 函数</strong></h4><pre><code class="hljs javascript"><span class="hljs-keyword">var</span> updateDownloaderDiv = <span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) &#123;
    <span class="hljs-keyword">const</span> element = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">getElementById</span>(<span class="hljs-string">&#x27;requestSnifferForMockDiv&#x27;</span>);
    <span class="hljs-keyword">if</span> (<span class="hljs-title class_">Object</span>.<span class="hljs-title function_">keys</span>(<span class="hljs-variable language_">window</span>.<span class="hljs-property">requestSnifferForMock</span>).<span class="hljs-property">length</span> &gt; <span class="hljs-number">0</span>) &#123;
        element.<span class="hljs-property">innerHTML</span> = <span class="hljs-string">&quot;&quot;</span>;
        <span class="hljs-title class_">Object</span>.<span class="hljs-title function_">keys</span>(<span class="hljs-variable language_">window</span>.<span class="hljs-property">requestSnifferForMock</span>).<span class="hljs-title function_">forEach</span>(<span class="hljs-function">(<span class="hljs-params">t</span>) =&gt;</span> &#123;
            element.<span class="hljs-title function_">appendChild</span>(<span class="hljs-title function_">addButton</span>(<span class="hljs-string">&#x27;  发送请求(&#x27;</span>+ <span class="hljs-variable language_">window</span>.<span class="hljs-property">requestSnifferForMock</span>[t].<span class="hljs-property">length</span> +<span class="hljs-string">&#x27;)  &#x27;</span>, exportFile.<span class="hljs-title function_">bind</span>(<span class="hljs-literal">undefined</span>, t)));
        &#125;);
    &#125; <span class="hljs-keyword">else</span> &#123;
        element.<span class="hljs-property">innerHTML</span> = <span class="hljs-string">&quot;loading...&quot;</span>;
    &#125;
&#125;;</code></pre>
<ul>
<li>功能：更新页面上的按钮容器，显示捕获的请求数据。</li>
<li>实现：<ul>
<li>获取按钮容器的 DOM 元素。</li>
<li>如果捕获到请求数据，为每个请求路径创建一个按钮，并绑定导出功能。</li>
<li>如果没有数据，显示“loading…”。</li>
</ul>
</li>
</ul>
<h4 id="3-4-removeHtmlFromJson-函数"><a href="#3-4-removeHtmlFromJson-函数" class="headerlink" title="3.4 removeHtmlFromJson 函数"></a>3.4 <strong><code>removeHtmlFromJson</code> 函数</strong></h4><pre><code class="hljs javascript"><span class="hljs-keyword">var</span> removeHtmlFromJson = <span class="hljs-keyword">function</span> (<span class="hljs-params">jsonData</span>) &#123;
    <span class="hljs-keyword">function</span> <span class="hljs-title function_">removeHtml</span>(<span class="hljs-params">text</span>) &#123;
        <span class="hljs-keyword">var</span> doc = <span class="hljs-keyword">new</span> <span class="hljs-title class_">DOMParser</span>().<span class="hljs-title function_">parseFromString</span>(text, <span class="hljs-string">&#x27;text/html&#x27;</span>);
        <span class="hljs-keyword">return</span> doc.<span class="hljs-property">body</span>.<span class="hljs-property">textContent</span> || <span class="hljs-string">&quot;&quot;</span>;
    &#125;

    <span class="hljs-keyword">function</span> <span class="hljs-title function_">removeHtmlRecursive</span>(<span class="hljs-params">obj</span>) &#123;
        <span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span> obj === <span class="hljs-string">&#x27;string&#x27;</span>) &#123;
            <span class="hljs-keyword">return</span> <span class="hljs-title function_">removeHtml</span>(obj);
        &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (<span class="hljs-title class_">Array</span>.<span class="hljs-title function_">isArray</span>(obj)) &#123;
            <span class="hljs-keyword">return</span> obj.<span class="hljs-title function_">map</span>(<span class="hljs-function"><span class="hljs-params">item</span> =&gt;</span> <span class="hljs-title function_">removeHtmlRecursive</span>(item));
        &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span> obj === <span class="hljs-string">&#x27;object&#x27;</span> &amp;&amp; obj !== <span class="hljs-literal">null</span>) &#123;
            <span class="hljs-keyword">var</span> newObj = &#123;&#125;;
            <span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> key <span class="hljs-keyword">in</span> obj) &#123;
                <span class="hljs-keyword">if</span> (obj.<span class="hljs-title function_">hasOwnProperty</span>(key)) &#123;
                    newObj[key] = <span class="hljs-title function_">removeHtmlRecursive</span>(obj[key]);
                &#125;
            &#125;
            <span class="hljs-keyword">return</span> newObj;
        &#125; <span class="hljs-keyword">else</span> &#123;
            <span class="hljs-keyword">return</span> obj;
        &#125;
    &#125;

    <span class="hljs-keyword">return</span> <span class="hljs-title function_">removeHtmlRecursive</span>(jsonData);
&#125;</code></pre>
<ul>
<li>功能：递归地移除 JSON 数据中的 HTML 标签。</li>
<li>实现：<ul>
<li>使用 <code>DOMParser</code> 解析字符串并提取纯文本。</li>
<li>递归处理数组和对象，确保所有字符串都被清理。</li>
</ul>
</li>
</ul>
<h4 id="3-5-重写-XMLHttpRequest-prototype-open"><a href="#3-5-重写-XMLHttpRequest-prototype-open" class="headerlink" title="3.5 重写 XMLHttpRequest.prototype.open"></a>3.5 <strong>重写 <code>XMLHttpRequest.prototype.open</code></strong></h4><pre><code class="hljs javascript"><span class="hljs-title class_">XMLHttpRequest</span>.<span class="hljs-property"><span class="hljs-keyword">prototype</span></span>.<span class="hljs-property">open</span> = <span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) &#123;
    <span class="hljs-keyword">const</span> request = &#123;
        <span class="hljs-attr">method</span>: <span class="hljs-variable language_">arguments</span>[<span class="hljs-string">&#x27;0&#x27;</span>]
    &#125;;
    <span class="hljs-keyword">const</span> url = <span class="hljs-variable language_">arguments</span>[<span class="hljs-string">&#x27;1&#x27;</span>];
    <span class="hljs-keyword">if</span> (url.<span class="hljs-title function_">includes</span>(<span class="hljs-string">&#x27;/list_new_json_5.php&#x27;</span>)) &#123;
        isRequestInProgress = <span class="hljs-literal">true</span>;
        <span class="hljs-keyword">const</span> index = url.<span class="hljs-title function_">indexOf</span>(<span class="hljs-string">&#x27;?&#x27;</span>);
        <span class="hljs-keyword">if</span> (index &gt;= <span class="hljs-number">0</span>) &#123;
            request.<span class="hljs-property">path</span> = url.<span class="hljs-title function_">substring</span>(<span class="hljs-number">0</span>, index);
            request.<span class="hljs-property">queryStringParameters</span> = url.<span class="hljs-title function_">substring</span>(url.<span class="hljs-title function_">indexOf</span>(<span class="hljs-string">&#x27;?&#x27;</span>) + <span class="hljs-number">1</span>).<span class="hljs-title function_">split</span>(<span class="hljs-string">&#x27;&amp;&#x27;</span>).<span class="hljs-title function_">map</span>(<span class="hljs-function">(<span class="hljs-params">t</span>) =&gt;</span> t.<span class="hljs-title function_">split</span>(<span class="hljs-string">&#x27;=&#x27;</span>)).<span class="hljs-title function_">reduce</span>(<span class="hljs-function">(<span class="hljs-params">agg, t</span>) =&gt;</span> (&#123; ...agg, [t[<span class="hljs-number">0</span>]] : [t[<span class="hljs-number">1</span>]]&#125;) , &#123;&#125;);
        &#125; <span class="hljs-keyword">else</span> &#123;
            request.<span class="hljs-property">path</span> = url;
        &#125;
        <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">&quot;load&quot;</span>, <span class="hljs-function">() =&gt;</span> &#123;
            <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">window</span>.<span class="hljs-property">requestSnifferForMock</span>[request.<span class="hljs-property">path</span>] == <span class="hljs-literal">null</span>) &#123;
                <span class="hljs-variable language_">window</span>.<span class="hljs-property">requestSnifferForMock</span>[request.<span class="hljs-property">path</span>] = [];
            &#125;
            <span class="hljs-variable language_">window</span>.<span class="hljs-property">requestSnifferForMock</span>[request.<span class="hljs-property">path</span>].<span class="hljs-title function_">push</span>(&#123;
                <span class="hljs-attr">httpRequest</span>: request,
                <span class="hljs-attr">httpResponse</span>: &#123;
                    <span class="hljs-attr">statusCode</span>: <span class="hljs-variable language_">this</span>.<span class="hljs-property">status</span>,
                    <span class="hljs-attr">body</span>: <span class="hljs-variable language_">this</span>.<span class="hljs-property">responseType</span> === <span class="hljs-string">&#x27;json&#x27;</span> ? <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">stringify</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">response</span>) : <span class="hljs-variable language_">this</span>.<span class="hljs-property">responseText</span>,
                &#125;,
            &#125;);
            <span class="hljs-title function_">fetch</span>(<span class="hljs-string">&#x27;https://w.zuzuche.com&#x27;</span>+ url, &#123;
                <span class="hljs-attr">method</span>: <span class="hljs-string">&#x27;get&#x27;</span>,
            &#125;)
                .<span class="hljs-title function_">then</span>(<span class="hljs-function"><span class="hljs-params">response</span> =&gt;</span> response.<span class="hljs-title function_">json</span>())
                .<span class="hljs-title function_">then</span>(<span class="hljs-function"><span class="hljs-params">res</span> =&gt;</span> &#123;
                    anotherVariable.<span class="hljs-title function_">push</span>(res);
                    isRequestInProgress = <span class="hljs-literal">false</span>;
                    <span class="hljs-title function_">resetInterval</span>();
                &#125;)
                .<span class="hljs-title function_">catch</span>(<span class="hljs-function"><span class="hljs-params">error</span> =&gt;</span> &#123;
                    <span class="hljs-built_in">clearInterval</span>(intervalRequest);
                    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(error);
                &#125;);

            <span class="hljs-title function_">updateDownloaderDiv</span>();
        &#125;);
    &#125;

    <span class="hljs-title class_">XMLHttpRequestOpen</span>.<span class="hljs-title function_">apply</span>(<span class="hljs-variable language_">this</span>, <span class="hljs-variable language_">arguments</span>);
&#125;;</code></pre>
<ul>
<li>功能：重写 <code>XMLHttpRequest</code> 的 <code>open</code> 方法，监听特定请求并捕获响应数据。</li>
<li>实现：<ul>
<li>解析请求的 URL 和方法。</li>
<li>如果 URL 包含 <code>/list_new_json_5.php</code>，则监听请求的 <code>load</code> 事件。</li>
<li>将请求和响应数据存储到 <code>window.requestSnifferForMock</code> 中。</li>
<li>发送一个额外的请求以获取更多数据，并更新按钮容器。</li>
</ul>
</li>
</ul>
<hr>
<h3 id="4-其他功能"><a href="#4-其他功能" class="headerlink" title="4. 其他功能"></a>4. <strong>其他功能</strong></h3><h4 id="4-1-checkRequestStatus-函数"><a href="#4-1-checkRequestStatus-函数" class="headerlink" title="4.1 checkRequestStatus 函数"></a>4.1 <strong><code>checkRequestStatus</code> 函数</strong></h4><pre><code class="hljs javascript"><span class="hljs-keyword">var</span> checkRequestStatus = <span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) &#123;
    <span class="hljs-keyword">if</span> (isRequestInProgress) &#123;
        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">&#x27;请求仍在进行中&#x27;</span>);
    &#125; <span class="hljs-keyword">else</span> &#123;
        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">&#x27;请求已完成&#x27;</span>);
        <span class="hljs-keyword">if</span>(<span class="hljs-variable language_">window</span>.<span class="hljs-property">requestSnifferForMock</span>[<span class="hljs-string">&#x27;/list_new_json_5.php&#x27;</span>].<span class="hljs-property">length</span> &gt; <span class="hljs-number">1</span>)&#123;
            <span class="hljs-title function_">sendRequest</span>();
        &#125;<span class="hljs-keyword">else</span>&#123;
            <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">&quot;请求错误&quot;</span>);
        &#125;
        <span class="hljs-built_in">clearInterval</span>(intervalRequest);
    &#125;
&#125;</code></pre>
<ul>
<li>功能：检查请求状态，如果请求完成则调用 <code>sendRequest</code>。</li>
</ul>
<h4 id="4-2-sendRequest-函数"><a href="#4-2-sendRequest-函数" class="headerlink" title="4.2 sendRequest 函数"></a>4.2 <strong><code>sendRequest</code> 函数</strong></h4><pre><code class="hljs javascript"><span class="hljs-keyword">var</span> sendRequest = <span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) &#123;
    <span class="hljs-keyword">const</span> requestData = anotherVariable[anotherVariable.<span class="hljs-property">length</span>-<span class="hljs-number">1</span>];
    <span class="hljs-title function_">fetch</span>(<span class="hljs-string">&#x27;https://avisapi.56zhiyun.com/export&#x27;</span>, &#123;
        <span class="hljs-attr">method</span>: <span class="hljs-string">&#x27;post&#x27;</span>,
        <span class="hljs-attr">headers</span>: &#123;
            <span class="hljs-string">&#x27;Content-Type&#x27;</span>: <span class="hljs-string">&#x27;text/plain&#x27;</span>,
        &#125;,
        <span class="hljs-attr">body</span>: <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">stringify</span>(requestData),
    &#125;)
        .<span class="hljs-title function_">then</span>(<span class="hljs-function"><span class="hljs-params">response</span> =&gt;</span> &#123;
            <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">&#x27;接收响应数据:&#x27;</span>, response);
            <span class="hljs-keyword">if</span> (!response.<span class="hljs-property">ok</span>) &#123;
                <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Error</span>(<span class="hljs-string">&#x27;请求出错&#x27;</span>);
            &#125;
            <span class="hljs-keyword">return</span> response.<span class="hljs-title function_">text</span>();
        &#125;)
        .<span class="hljs-title function_">then</span>(<span class="hljs-function"><span class="hljs-params">data</span> =&gt;</span> &#123;
            <span class="hljs-keyword">const</span> url = data;
            <span class="hljs-keyword">if</span> (url) &#123;
                <span class="hljs-variable language_">window</span>.<span class="hljs-property">location</span>.<span class="hljs-property">href</span> = url;
            &#125; <span class="hljs-keyword">else</span> &#123;
                <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">&#x27;未找到有效的数据URL&#x27;</span>);
            &#125;
        &#125;)
        .<span class="hljs-title function_">catch</span>(<span class="hljs-function"><span class="hljs-params">error</span> =&gt;</span> &#123;
            <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">&#x27;接收的数据请求出错:&#x27;</span>, error);
        &#125;);
&#125;;</code></pre>
<ul>
<li>功能：将捕获的数据发送到指定 API，并处理响应。</li>
</ul>
<h4 id="4-3-定时器和初始化"><a href="#4-3-定时器和初始化" class="headerlink" title="4.3 定时器和初始化"></a>4.3 <strong>定时器和初始化</strong></h4><pre><code class="hljs javascript"><span class="hljs-keyword">var</span> intervalId = <span class="hljs-built_in">setInterval</span>(<span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) &#123;
    <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">document</span>.<span class="hljs-property">body</span>) &#123;
        <span class="hljs-built_in">clearInterval</span>(intervalId);
        <span class="hljs-keyword">var</span> div = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">createElement</span>(<span class="hljs-string">&#x27;div&#x27;</span>);
        div.<span class="hljs-title function_">setAttribute</span>(<span class="hljs-string">&#x27;id&#x27;</span>, <span class="hljs-string">&#x27;requestSnifferForMockDiv&#x27;</span>);
        div.<span class="hljs-title function_">setAttribute</span>(<span class="hljs-string">&#x27;style&#x27;</span>, <span class="hljs-string">&#x27;text-align:center;color:#4e7cdd;background-color: yellow;padding:12px 24px;border-radius: 8px;  position: fixed; z-index: 9999; top: 120px;&#x27;</span>);
        <span class="hljs-variable language_">document</span>.<span class="hljs-property">body</span>.<span class="hljs-title function_">appendChild</span>(div);
        <span class="hljs-title function_">startup</span>();
    &#125;
&#125;, <span class="hljs-number">100</span>);

<span class="hljs-keyword">function</span> <span class="hljs-title function_">resetInterval</span>(<span class="hljs-params"></span>) &#123;
    <span class="hljs-built_in">clearInterval</span>(intervalRequest);
    intervalRequest = <span class="hljs-built_in">setInterval</span>(checkRequestStatus, <span class="hljs-number">6000</span>);
&#125;</code></pre>
<ul>
<li>功能：在页面加载完成后初始化脚本，并设置定时器检查请求状态。</li>
</ul>
<hr>
<h3 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h3><p>该脚本的核心功能是监听特定 Ajax 请求，捕获请求和响应数据，并将其以 Mockserver 格式导出。通过重写 <code>XMLHttpRequest</code> 的 <code>open</code> 方法，实现了对请求的拦截和处理。同时，脚本在页面上动态创建按钮，方便用户下载数据。</p>

  </div>
  <!-- <div id="gitalk-container"></div> -->
</div>

<script>
  
Fancybox.bind('[data-fancybox="fancybox-gallery-img"]', {
  dragToClose: true,
  Toolbar: true,
  closeButton: "top",
  Image: {
    zoom: true,
  },
  on: {
    initCarousel: (fancybox) => {
      const slide = fancybox.Carousel.slides[fancybox.Carousel.page];
      fancybox.$container.style.setProperty(
        "--bg-image",
        `url("${slide.$thumb.src}")`
      );
    },
    "Carousel.change": (fancybox, carousel, to, from) => {
      const slide = carousel.slides[to];
      fancybox.$container.style.setProperty(
        "--bg-image",
        `url("${slide.$thumb.src}")`
      );
    },
  },
});
</script>

<style>
    #noneimg img {
        display: none;
        z-index: 9999;
        /* width: 600px !important; */
        min-width: 0%;
        max-width: 90%;
        max-height: 80%;
        border-radius: 0px;
        position: fixed;
        box-shadow: 0 0 0px #c3c3c300 !important;
        left: 0;
        top: 0;
        right: 0;
        bottom: 0;
        margin: auto !important;
    }

    @media screen and (max-width:600px) {
        #noneimg img {
            max-width: 88%
        }
    }
</style>

    <div class="post-paging">
    
    <a href="/2023/08/10/OCR/">
        <div class="post-paging-last">
            <span>上一篇</span>
            <p>OCR（光学字符识别）</p>
        </div>
    </a>
    

    
    <a href="/2023/01/02/addRoutes/">
        <div class="post-paging-next">
            <span>下一篇</span>
            <p>Vue 动态路由配置与权限控制</p>
        </div>
    </a>
    
</div>
</div>
		
<div class="footer">
	<div class="Copyright">
		©2025 By 付鹏篚. 主题：<a
			style="text-decoration: none;display: contents; color: #898F9F;"
			href="#">Quiet</a>
	</div>
	<div class="contact">
		
		<a target="_blank" rel="noopener" href="https://github.com/newbiefpf">
			<img src="/image/logo.png" alt="Quiet主题">
		</a>
		
	</div>
</div>

<script src="/js/gotop.js"></script>


<style type="text/css">
    @media screen and (min-width: 600px) {
        .goTop>span {
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 10px;
            width: 40px;
            height: 40px;
            cursor: pointer;
            opacity: 0.8;
            background: #F1F5FB;
            text-align: center;
            transition: border .5s;
            border: 1px solid rgba(18, 24, 58, 0.06);

            -moz-transition: border .5s;
            /* Firefox 4 */
            -webkit-transition: border .5s;
            /* Safari 和 Chrome */
            -o-transition: border .5s;
            /* Opera */
        }

        .goTop>span:hover {
            border: 1px solid #6680B3;
        }


        .goTop {
            position: fixed;
            right: 30px;
            bottom: 80px;
        }

        .goTop>span>svg {
            width: 20px;
            height: 20px;
            opacity: 0.7;
        }

    }

    @media screen and (max-width: 600px) {
        .goTop {
            display: none;
        }
    }
</style>
<div class="goTop" id="js-go_top">
    <span>
        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24">
            <g>
                <path d="M13 12v8h-2v-8H4l8-8 8 8z"></path>
            </g>
        </svg>
    </span>
</div>
<script>
    $( '#js-go_top' )
	.gotoTop( {
		offset: 500,
		speed: 300,
		animationShow: {
			'transform': 'translate(0,0)',
			'transition': 'transform .5s ease-in-out'
		},
		animationHide: {
			'transform': 'translate(100px,0)',
			'transition': 'transform .5s ease-in-out'
		}
	} );
</script>


    <!-- Gitalk -->
    <script>
        const data = '{"clientID":"02b3c","clientSecret":"adfc7b4","repo":"gimment","owner":"duneng","admin":"duneng"}'
        const gitalk = new Gitalk({
            ...JSON.parse( data),
            id:location.pathname,
            distractionFreeMode:false
        })
        
        // if(Boolean('true')){
        //     gitalk.render('gitalk-container')
        // }
    </script>


	</body>
</html>

